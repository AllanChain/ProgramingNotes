<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <!-- 接着引入API和JQuery： -->
    <script type="text/JavaScript" src="https://api.map.baidu.com/api?v=2.0&ak=Ra7pfVaOAGRU0zCsACiQAduq6wLOHIH0"></script>
    <script type="text/JavaScript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <title>桐高2019届300班蹭饭图</title>
    <!-- 在body标签中加入div用于显示地图 -->
    <!-- 最后设置div样式 -->
    <style type="text/css">
body, html,#allmap {
  width: 100%;
  height: 100%;
  overflow: hidden;
  margin:0;
  font-family:"微软雅黑";
}

.search_box{
  position: absolute;
  top: 0
}
.infoUniversity{
  background-color: #300;
  color: #ddd;
  font-size: 20px;
  opacity: 0.5;
  position: absolute;
  width: 80%;
  height: 30%;
  top: 10%;
  left: 10%;
  padding: 5px;
  overflow-y: scroll;
}
    </style>

    <script type="text/javascript" src="release.json"></script>
    <div id="allmap"></div>
    <!-- 三、开始定位 -->
    <script type="text/javascript">
      var map = new BMap.Map("allmap");//创建地图实例
var current_id = 0;
$(function() {
  //初始化地图 默认加载北京天安门
  var point = new BMap.Point(116.331398,39.897445);
  map.centerAndZoom(point,6);//初始化地图，point为中心点，缩放级别为16
  //新建标注
  universities.forEach(setMarker);
});
function setMarker(data, index){
  var point = new BMap.Point(data.Lng, data.Lat);
  var mk = new BMap.Marker(point);
  var label = new BMap.Label('<b>'+data.University+'</b>');
  data.Marker = mk;
  mk.setLabel(label);
  mk.disableDragging();// 不可拖拽
  map.addOverlay(mk);
  label.setStyle({
    //borderColor: "#808080",
    borderWidth: 0,
    color: "#ddd",
    cusor: "pointer",
    backgroundColor: "#ec2d2d"
  });
  //给标注点添加点击事件。使用立即执行函数和闭包
  //Closure: function in function, lenthening the life time of variable
  (function() {
    mk.addEventListener("click",function(){
      showInfo(data);
    });
  })();
  (function() {
    label.addEventListener("click",function(){
      showInfo(data);
    });
  })();
}

function showInfo(data, hilite=-1){
  clearInfoDiv();
  var sContent = '<div class="infoUniversity" onclick="clearInfoDiv();map.setZoom(6)">'
  if (hilite == -2){
    sContent += '<b>' + data.University + '</b>'
  }else{
    sContent += data.University
  };
  sContent += '<ul>';
  data.Students.forEach(function(student, index){
    if (index == hilite){
      sContent += '<li class="info_li"><b>' + student + '</b></li>'
    }else{
      sContent += '<li class="info_li">' + student + '</li>'
    }});
  sContent += '</ul></div>';
  map.centerAndZoom(data.Marker.getPosition(), 9);
  sContent = $.parseHTML(sContent);
  $(sContent).appendTo("body")
  $("body").add(sContent);
}
function clearInfoDiv(){
  $(".infoUniversity").remove()
}
function search(){
  if ($("#search_button").text() == "搜索"){
    $("#search_button").text("下个");
    current_id = 0;
    query = $("#search_input").val();
    results = getAll(query);
    console.log(results);
  }
  current_id += 1;
  if (current_id >= results.length){
    current_id = 0
  }
  showInfo(results[current_id].item, results[current_id].hilite);
}
function entersearch(event){
  if (event.keyCode == 13){
    search();
  }else{
    $("#search_button").text("搜索");
  }
}
function getAll(query){
  results = []
  console.log(current_id);
  for(var i = 0; i < universities.length; i++){
    data = universities[i];
    students = data.Students
    for(var j = 0; j < students.length; j++){
      if (chrsInStr(query, students[j])){
        results.push({item: data, hilite: j});
      }
    };
  };
  for(var i = 0,len = universities.length; i < len; i++){
    data = universities[i];
    if (chrsInStr(query, data.University)){
      results.push({item: data, hilite: -2})
      }
  };
  return results
}
//简称必须是全称中按顺序取的字
function chrsInStr(chrs, str){
  j = 0
  for (var i=0; i < chrs.length; i++){
    chr = chrs.charAt(i);
    while (str.charAt(j) != chr){
      j++;
      if (j == str.length){
        return false
      }
    }
    j++;
  }
  return true
}
    </script>
  </head>
  <body>
    <div class="search_box">
      <input id="search_input" onkeydown="entersearch(event)"/>
      <button id="search_button" onclick="search()">搜索</button>
    </div>
  </body>
</html>
