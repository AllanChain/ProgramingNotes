<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <!-- 接着引入API和JQuery： -->
    <script type="text/JavaScript" src="https://api.map.baidu.com/api?v=2.0&ak=Ra7pfVaOAGRU0zCsACiQAduq6wLOHIH0"></script>
    <script type="text/JavaScript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/JavaScript" src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.4.5/fuse.min.js"></script>
    <!-- 在body标签中加入div用于显示地图 -->
    <div id="allmap"></div>
    <div class="search_box">
      <input id="search_input" onkeydown="entersearch(event)"/>
      <button id="search_button" onclick="search()">搜索</button>
    </div>
    <!-- 最后设置div样式 -->
    <style type="text/css">
body, html,#allmap {
  width: 100%;
  height: 100%;
  overflow: hidden;
  margin:0;
  font-family:"微软雅黑";
}

.search_box{
  position: absolute;
  top: 0
}
    </style>

    <script type="text/javascript" src="release.json"></script>
    <!-- 三、开始定位 -->
    <script type="text/javascript">
var map = new BMap.Map("allmap");//创建地图实例
var options = {
  includeScore: true,
  includeMatches: true,
  threshold: 0.5,
  keys: ['University', 'Students']
};
var fuse = new Fuse(universities, options);
var search_results = {};
var current_id = 0;
$(function() {
  //初始化地图 默认加载北京天安门
  var point = new BMap.Point(116.331398,39.897445);
  map.centerAndZoom(point,6);//初始化地图，point为中心点，缩放级别为16
  //新建标注
  universities.forEach(setMarker);
});
function setMarker(data, index){
  var point = new BMap.Point(data.Lng, data.Lat);
  var mk = new BMap.Marker(point);
  var label = new BMap.Label('<b>'+data.University+'</b>');
  data.Marker = mk;
  mk.setLabel(label);
  mk.disableDragging();// 不可拖拽
  map.addOverlay(mk);
  label.setStyle({
    //borderColor: "#808080",
    borderWidth: 0,
    color: "#ddd",
    cusor: "pointer",
    backgroundColor: "#ec2d2d"
  });
  //给标注点添加点击事件。使用立即执行函数和闭包
  //Closure: function in function, lenthening the life time of variable
  (function() {
    mk.addEventListener("click",function(){
      showInfo(this, data);
    });
  })();
}

function showInfo(thisMarker,data, hilite=-1){
  var sContent = '<ul>';
  data.Students.forEach(function(student, index){
    if (index == hilite){
      sContent += '<li class="info_li"><b>' + student + '</b></li>'
    }else{
      sContent += '<li class="info_li">' + student + '</li>'
    }});
  sContent += '</ul>'
  var infoWindow = new BMap.InfoWindow(sContent);// 创建信息窗口对象
  thisMarker.openInfoWindow(infoWindow);//图片加载完毕重绘infowindow
  infoWindow.setTitle(data.University);
  infoWindow.setWidth(300);
}
function search(){
  if ($("#search_button").text() == "搜索"){
    $("#search_button").text("下个");
    current_id = 0;
    query = $("#search_input").val();
    results = fuse.search(query);
    console.log(results);
  }
  current_id += 1;
  if (current_id >= results.length){
    current_id = 0
  }
  data = results[current_id].item;
  showInfo(data.Marker, data);
}
function entersearch(event){
  if (event.keyCode == 13){
    search();
  }else{
    $("#search_button").text("搜索");
  }
}
    </script>
  </head>
  <body>
  </body>
</html>
